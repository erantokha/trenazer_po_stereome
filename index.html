<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Тренажер по формулам стереометрии</title>
  <style>
    :root {
      --bg:#0f1115; --card:#171a21; --text:#e7eaf0; --muted:#9aa3b2;
      --accent:#4da3ff; --good:#38d39f; --bad:#ff6b6b;
      --border:#232835;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      -webkit-text-size-adjust:100%;
    }
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:16px;
      padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.22)
    }
    h1{margin:0 0 8px;font-size:20px;line-height:1.25}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .qtext{font-size:18px;line-height:1.4;margin:14px 0 6px;word-break:break-word}
    .opts{display:grid;gap:10px;margin:10px 0}
    .opt{
      padding:14px;background:#11141a;border:1px solid var(--border);border-radius:12px;
      cursor:pointer;display:flex;gap:10px;align-items:flex-start
    }
    .opt input{width:22px;height:22px;margin-top:1px;flex:0 0 auto;}
    .opt .txt{line-height:1.35;word-break:break-word}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:1px solid #2a3140;background:#11141a;color:var(--text);
      padding:12px 14px;border-radius:12px;cursor:pointer;touch-action:manipulation;
      font-size:16px;min-width:100px
    }
    button.primary{background:var(--accent);border-color:transparent;color:#07131f}
    button.ghost{background:transparent}
    button.linklike{background:none;border:none;color:var(--accent);cursor:pointer;padding:0;min-width:0}
    button:disabled{opacity:.5;cursor:not-allowed}
    .timer{font-variant-numeric:tabular-nums}
    .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;border:1px solid var(--border);border-radius:12px;margin-top:10px}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .ok{color:var(--good)} .no{color:var(--bad)}
    .hidden{display:none}
    .tiny{font-size:12px;color:var(--muted)}
    .status{margin-top:8px;font-size:14px;color:var(--muted)}
    .head-mini{font-size:14px;color:var(--muted)}
    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;padding:16px;z-index:50
    }
    .modal{max-width:560px;width:100%;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    .chkrow{display:flex;gap:10px;align-items:center;margin:6px 0}
    .chkrow input{width:20px;height:20px}
    .muted{color:var(--muted)}
    @media (max-width: 520px){
      .wrap{padding:12px}
      h1{font-size:18px}
      .qtext{font-size:17px}
      .opt{padding:14px}
      .opt input{width:24px;height:24px}
      .btns button{flex:1}
      table{min-width:640px}
    }
    /* fix: ensure modal hides when .hidden is present */
  .modal-backdrop.hidden { display: none !important; }
</style>

  <!-- MathJax v3 -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)'], ['$', '$']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true
      },
      options: {
        skipHtmlTags: {'[+]': ['noscript','style','textarea','pre','code']}
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <script>
    const APP_VERSION = "infinite-topics@1.1.0-14q-toggle";
    const STATS_MODE = "supabase";

    const SUPABASE_URL  = "https://yifkowufwjehwwnrnhvz.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpZmtvd3Vmd2plaHd3bnJuaHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDAzODksImV4cCI6MjA3NjgxNjM4OX0.EG2Bj3892hUBXjoDc4LYFtz28Q7_uDtGd-UJXOmcmac";
    const SUPABASE_TABLE = "attempts";

    const QUEUE_KEY = "pendingAttemptsV1";
    const STUDENT_KEY = "studentIdV1";

    const $ = (s,r=document)=>r.querySelector(s);

    function uuidv4(){
      const b = new Uint8Array(16);
      crypto.getRandomValues(b);
      b[6]=(b[6]&0x0f)|0x40; b[8]=(b[8]&0x3f)|0x80;
      const toHex = n=>n.toString(16).padStart(2,"0");
      const s = Array.from(b,toHex).join("");
      return `${s.slice(0,8)}-${s.slice(8,12)}-${s.slice(12,16)}-${s.slice(16,20)}-${s.slice(20)}`;
    }
    function fnv1aHash(str){ let h=0x811c9dc5; for (let c of str){ h^=c.charCodeAt(0); h=Math.imul(h,0x01000193);} return (h>>>0).toString(16); }
    function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),t|1); t^=t+Math.imul(t^(t>>>7),t|61); return ((t^(t>>>14))>>>0)/4294967296; }; }
    function fmtTime(ms){ const t=Math.max(0,Math.round(ms)); const m=Math.floor(t/60000), s=Math.floor((t%60000)/1000), cs=Math.floor((t%1000)/10); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${String(cs).padStart(2,'0')}`; }
    async function typeset(root){ if (window.MathJax && MathJax.typesetPromise){ try{ await MathJax.typesetPromise([root||document.body]); }catch(e){} } }

    // === Банк вопросов (14) ===
    const BANK = [
      { qid:"cyl_vol", topic:"цилиндр", stem:"Объём цилиндра равен",
        opts:["\\(\\pi r h^2\\)","\\(2\\pi r^2 h\\)","\\(\\pi r^2 h\\)","\\(\\tfrac13\\pi r^2 h\\)","\\(2\\pi r h\\)","\\(\\pi r(h + r)\\)","\\(\\tfrac{4}{3}\\pi r^3\\)","\\(2\\pi r^2 + 2\\pi r h\\)"],
        correct:2 },
      { qid:"cyl_area_total", topic:"цилиндр", stem:"Полная площадь поверхности цилиндра равна",
        opts:["\\(2\\pi r h + 2\\pi r^2\\)","\\(\\pi r^2 h\\)","\\(2\\pi r h\\)","\\(\\pi r(h + r)\\)","\\(\\pi r^2 + \\pi r h\\)","\\(4\\pi r^2\\)","\\(2\\pi r(h + 2r)\\)","\\(\\pi r^2 + 2\\pi r\\)"],
        correct:0 },
      { qid:"cyl_vol_formula", topic:"цилиндр", stem:"Формула объёма цилиндра:",
        opts:["\\(V=\\pi r^2\\cdot h\\)","\\(V=2\\pi r^2\\cdot h\\)","\\(V=\\tfrac13\\,\\pi r^2\\cdot h\\)","\\(V=\\pi r^2\\cdot 2h\\)","\\(V=\\dfrac{\\pi r^2}{2h}\\)","\\(V=\\tfrac{4}{3}\\,\\pi r^2\\cdot h\\)","\\(V=\\pi r^2\\cdot \\pi h\\)","\\(V=\\pi r^2+h\\)"],
        correct:0 },
      { qid:"cyl_area_formula", topic:"цилиндр", stem:"Формула полной площади поверхности цилиндра:",
        opts:["\\(S_{\\text{полн}}=2\\pi r^2+2\\pi r h\\)","\\(S_{\\text{полн}}=\\pi r^2+2\\pi r h\\)","\\(S_{\\text{полн}}=2\\pi r^2+\\pi r h\\)","\\(S_{\\text{полн}}=2\\pi r^2+P_{\\text{осн}}\\cdot h\\)","\\(S_{\\text{полн}}=\\pi r^2\\)","\\(S_{\\text{полн}}=4\\pi r^2\\)","\\(S_{\\text{полн}}=2\\pi r^2+2\\pi r^2 h\\)","\\(S_{\\text{полн}}=\\pi r(h+r)\\)"],
        correct:0 },
      { qid:"cone_vol", topic:"конус", stem:"Объём конуса равен",
        opts:["\\(\\pi r^2 h\\)","\\(\\tfrac12\\pi r^2 h\\)","\\(\\tfrac13\\pi r^2 h\\)","\\(\\tfrac23\\pi r^2 h\\)","\\(\\pi r l\\)","\\(\\tfrac{4}{3}\\pi r^3\\)","\\(\\pi r(h+l)\\)","\\(2\\pi r h\\)"],
        correct:2 },
      { qid:"cone_area_total", topic:"конус", stem:"Полная площадь поверхности конуса равна",
        opts:["\\(\\pi r l + \\pi r^2\\)","\\(2\\pi r l + \\pi r^2\\)","\\(\\pi r(l+h)\\)","\\(\\pi r^2 h\\)","\\(2\\pi r(h+r)\\)","\\(\\pi r^2 + 2\\pi r h\\)","\\(\\pi r(l + r/2)\\)","\\(4\\pi r^2\\)"],
        correct:0 },
      { qid:"cone_vol_formula", topic:"конус", stem:"Формула объёма конуса:",
        opts:["\\(V=\\pi r^2\\cdot h\\)","\\(V=\\tfrac12\\,\\pi r^2\\cdot h\\)","\\(V=\\tfrac13\\,\\pi r^2\\cdot h\\)","\\(V=\\tfrac23\\,\\pi r^2\\cdot h\\)","\\(V=\\pi r^2\\cdot 2h\\)","\\(V=\\dfrac{\\pi r^2}{3h}\\)","\\(V=\\tfrac{4}{3}\\,\\pi r^2\\cdot h\\)","\\(V=\\pi r^2+h\\)"],
        correct:2 },
      { qid:"cone_area_formula", topic:"конус", stem:"Формула полной площади поверхности конуса:",
        opts:["\\(S_{\\text{полн}}=\\pi r^2+\\pi r l\\)","\\(S_{\\text{полн}}=2\\pi r^2+\\pi r l\\)","\\(S_{\\text{полн}}=\\pi r^2+2\\pi r l\\)","\\(S_{\\text{полн}}=\\pi r l\\)","\\(S_{\\text{полн}}=\\pi r^2 l\\)","\\(S_{\\text{полн}}=2\\pi r(h+r)\\)","\\(S_{\\text{полн}}=\\pi r h+\\pi r^2\\)","\\(S_{\\text{полн}}=4\\pi r^2\\)"],
        correct:0 },
      { qid:"prism_vol", topic:"призма", stem:"Объём прямой треугольной призмы равен",
        opts:["\\(V=P_{\\text{осн}}\\cdot h\\)","\\(V=S_{\\text{осн}}\\cdot h\\)","\\(V=\\tfrac12 P_{\\text{осн}}\\cdot h\\)","\\(V=2S_{\\text{осн}}\\cdot h\\)","\\(V=\\tfrac{S_{\\text{осн}}}{2h}\\)","\\(V=(S_{\\text{осн}}+P_{\\text{осн}})\\cdot h\\)","\\(\\pi r^2 h\\)","\\(\\tfrac{4}{3}\\pi r^3\\)"],
        correct:1 },
      { qid:"sphere_area", topic:"шар", stem:"Площадь поверхности шара равна",
        opts:["\\(2\\pi r^2\\)","\\(3\\pi r^2\\)","\\(4\\pi r^2\\)","\\(\\tfrac{4}{3}\\pi r^3\\)","\\(\\pi r^2 h\\)","\\(2\\pi r h\\)","\\(\\pi r l + \\pi r^2\\)","\\(8\\pi r^2\\)"],
        correct:2 },
      { qid:"sphere_vol", topic:"шар", stem:"Объём шара равен",
        opts:["\\(4\\pi r^3\\)","\\(\\tfrac{4}{3}\\pi r^3\\)","\\(\\tfrac13\\pi r^3\\)","\\(\\pi r^3\\)","\\(\\pi r^2 h\\)","\\(\\tfrac23\\pi r^3\\)","\\(2\\pi r^3\\)","\\(4\\pi r^2\\)"],
        correct:1 },
      { qid:"sphere_pair", topic:"шар", stem:"Выберите единственную верную пару \\((S,V)\\) для шара:",
        opts:["\\(S=2\\pi r^2,\\;V=\\tfrac{4}{3}\\pi r^3\\)","\\(S=3\\pi r^2,\\;V=\\pi r^3\\)","\\(S=4\\pi r^2,\\;V=\\tfrac{4}{3}\\pi r^3\\)","\\(S=4\\pi r^2,\\;V=\\pi r^3\\)","\\(S=2\\pi r^2,\\;V=\\tfrac23\\pi r^3\\)","\\(S=4\\pi r^2,\\;V=2\\pi r^3\\)","\\(S=\\pi r^2,\\;V=\\tfrac{4}{3}\\pi r^3\\)","\\(S=4\\pi r^2,\\;V=\\tfrac13\\pi r^3\\)"],
        correct:2 },
      { qid:"circle_area", topic:"круг", stem:"Площадь круга равна",
        opts:["\\(\\pi r^2\\)","\\(2\\pi r^2\\)","\\(\\pi r\\)","\\(2\\pi r\\)","\\(\\tfrac{4}{3}\\pi r^3\\)","\\(\\pi r^2 h\\)","\\(\\pi r l\\)","\\(4\\pi r^2\\)"],
        correct:0 },
      { qid:"circle_circumference", topic:"окружность", stem:"Длина окружности равна",
        opts:["\\(2\\pi r\\)","\\(\\pi r^2\\)","\\(4\\pi r\\)","\\(\\pi r\\)","\\(\\tfrac12\\pi r\\)","\\(2\\pi r^2\\)","\\(\\tfrac{4}{3}\\pi r^3\\)","\\(\\pi r^2 h\\)"],
        correct:0 }
    ];
    const BANK_HASH = fnv1aHash(JSON.stringify(BANK.map(q=>({qid:q.qid,stem:q.stem,opts:q.opts,correct:q.correct}))));

    // === Состояние сессии ===
    let rng=null, seed=0;
    let questions=[], answers=[], times=[];
    let cur=0, startStamp=null, rafId=null, sessionStartedAt=null;
    let selectedTopics = []; // массив базовых тем
    let filteredBank = [];   // BANK после фильтра по темам
    const recentQids = [];   // для анти-повтора
    const RECENT_WINDOW = 3; // избегать повторов из последних 3, если возможно

    // === RNG ===
    function seededRandom(){ return rng ? rng() : Math.random(); }
    function shuffle(a){ a=[...a]; for (let i=a.length-1;i>0;i--){ const j=Math.floor(seededRandom()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function sample(a,k){ return shuffle(a).slice(0,k); }

    // === Выбор тем ===
    function openTopicsModal(reset=false){
      const m = document.getElementById("topicsModal");
      m.classList.remove("hidden");
      if (reset){
        for (const cb of m.querySelectorAll('input[type="checkbox"]')) cb.checked = false;
      }
      updateSelectAllLabel();
      validateTopicsSelection();
    }
    function closeTopicsModal(){ document.getElementById("topicsModal").classList.add("hidden"); }
    function getSelectedTopicKeys(){
      const res=[];
      const m=document.getElementById("topicsModal");
      for (const cb of m.querySelectorAll('input[type="checkbox"]')){
        if (cb.checked) res.push(cb.value);
      }
      return res;
    }
    function setAllTopics(checked){
      const m=document.getElementById("topicsModal");
      for (const cb of m.querySelectorAll('input[type="checkbox"]')) cb.checked = !!checked;
      updateSelectAllLabel();
      validateTopicsSelection();
    }
    function selectAllToggle(){
      const m=document.getElementById("topicsModal");
      const cbs = [...m.querySelectorAll('input[type="checkbox"]')];
      const allChecked = cbs.length>0 && cbs.every(cb => cb.checked);
      setAllTopics(!allChecked); // если всё было выбрано — снять; иначе — выбрать все
    }
    function updateSelectAllLabel(){
      const m=document.getElementById("topicsModal");
      const cbs = [...m.querySelectorAll('input[type="checkbox"]')];
      const allChecked = cbs.length>0 && cbs.every(cb => cb.checked);
      const btn = document.getElementById("selectAll");
      btn.textContent = allChecked ? "Сбросить все" : "Выбрать все";
    }
    function validateTopicsSelection(){
      const keys = getSelectedTopicKeys();
      const btn = document.getElementById("startBtn");
      const warn = document.getElementById("topicsWarn");
      btn.disabled = keys.length===0;
      warn.textContent = keys.length===0 ? "Нужно выбрать хотя бы одну тему" : "";
    }
    function keysToTopics(keys){
      const set = new Set();
      for (const k of keys){
        if (k==="circlebundle"){ set.add("круг"); set.add("окружность"); }
        else set.add(k);
      }
      return Array.from(set);
    }

    // === Генерация вопросов ===
    function materializeOne(base){
      const all=[...Array(base.opts.length).keys()];
      const wrong=all.filter(i=>i!==base.correct);
      const picked=sample(wrong,3);
      const choiceIdxs=shuffle([base.correct, ...picked]);
      const correctRendered=choiceIdxs.indexOf(base.correct);
      return { qid:base.qid, topic:base.topic, stem:base.stem, opts:base.opts, choiceIdxs, correctRendered };
    }
    function pickBaseQuestion(){
      if (filteredBank.length===0) return null;
      const candidates = filteredBank.filter(b => !recentQids.includes(b.qid));
      const pool = candidates.length ? candidates : filteredBank;
      const idx = Math.floor(seededRandom()*pool.length);
      const base = pool[idx];
      recentQids.push(base.qid);
      if (recentQids.length > Math.min(RECENT_WINDOW, filteredBank.length-1)) recentQids.shift();
      return base;
    }
    function generateNextQuestion(){
      const base = pickBaseQuestion();
      if (!base) return null;
      return materializeOne(base);
    }
    function ensureQuestion(index){
      while (questions.length <= index){
        const mat = generateNextQuestion();
        if (!mat) break;
        questions.push(mat);
        answers.push(null);
        times.push(0);
      }
    }

    // === Сессия ===
    function startSession(withTopicsKeys){
      const buf=new Uint32Array(1); crypto.getRandomValues(buf); seed=buf[0]>>>0; rng=mulberry32(seed);
      recentQids.length = 0;

      selectedTopics = keysToTopics(withTopicsKeys);
      filteredBank = BANK.filter(q => selectedTopics.includes(q.topic));
      if (filteredBank.length===0) return;

      questions = []; answers = []; times = [];
      cur = 0; startStamp = null; rafId = null; sessionStartedAt = new Date();

      closeTopicsModal(); // скрыть окно выбора тем
      ensureQuestion(0);
      render(); startTimer();
    }

    // === Таймеры ===
    function startTimer(){
      cancelAnimationFrame(rafId);
      let last=performance.now();
      const step=()=>{
        const now=performance.now(), dt=now-last;
        if (startStamp!==null) times[cur]+=dt;
        last=now;
        if (!step._acc) step._acc=0; step._acc+=dt;
        if (step._acc>=200){ document.querySelector(".timer").textContent = fmtTime(times[cur]); step._acc=0; }
        rafId=requestAnimationFrame(step);
      };
      startStamp=performance.now(); rafId=requestAnimationFrame(step);
    }
    function stopTimer(){ cancelAnimationFrame(rafId); rafId=null; startStamp=null; }

    // === Рендер и навигация ===
    async function render(){
      const q=questions[cur];
      document.getElementById("qnum").textContent = `Вопрос ${cur+1}`;
      document.querySelector(".qtext").innerHTML = q.stem;
      const box=document.querySelector(".opts"); box.innerHTML="";
      q.choiceIdxs.forEach((origIdx,i)=>{
        const div=document.createElement("label"); div.className="opt";
        div.innerHTML=`<input type="radio" name="q${cur}" value="${i}"><span class="txt">${q.opts[origIdx]}</span>`;
        const input=div.querySelector("input");
        input.checked=(answers[cur]===i);
        input.addEventListener("change",e=>{ answers[cur]=Number(e.target.value); },{passive:true});
        box.appendChild(div);
      });
      document.getElementById("prev").disabled=(cur===0);
      await typeset(document.getElementById("quiz"));
    }
    function nextQ(){
      if (cur === questions.length-1){
        ensureQuestion(cur+1);
      }
      cur = Math.min(cur+1, questions.length-1);
      render();
    }
    function prevQ(){
      if (cur>0){ cur -= 1; render(); }
    }

    // === Очередь оффлайн ===
    function loadQueue(){ try{return JSON.parse(localStorage.getItem(QUEUE_KEY)||"[]");}catch(e){return[];} }
    function saveQueue(a){ localStorage.setItem(QUEUE_KEY, JSON.stringify(a)); }
    async function trySendQueued(item){
      try{ await sendToSupabase(item.payload); return true; }catch(e){ return false; }
    }
    async function flushQueue(){
      const now=Date.now(); let q=loadQueue(); let changed=false;
      for (let i=0;i<q.length;i++){
        const it=q[i]; if (it.nextTryAt && it.nextTryAt>now) continue;
        const ok=await trySendQueued(it);
        if (ok){ q.splice(i,1); i--; changed=true; }
        else{ it.tries=(it.tries||0)+1; const backoff=Math.min(600000, 2000*Math.pow(2, Math.min(it.tries,7))); it.nextTryAt=now+backoff; changed=true; }
      }
      if (changed) saveQueue(q); return q.length;
    }
    function enqueueAttempt(payload){
      const q=loadQueue(); q.push({transport:"supabase", payload, tries:0, nextTryAt:Date.now()}); saveQueue(q);
    }

    // === Отправка попытки ===
    async function sendToSupabase(payload){
      const url = `${SUPABASE_URL}/rest/v1/${encodeURIComponent(SUPABASE_TABLE)}`;
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json", apikey:SUPABASE_ANON, Authorization:`Bearer ${SUPABASE_ANON}`, Prefer:"return=minimal" },
        body: JSON.stringify(payload)
      });
      if (!res.ok){ const txt = await res.text().catch(()=>`HTTP ${res.status}`); throw new Error(txt || `HTTP ${res.status}`); }
      return true;
    }

    function buildSummary(rows, correctCount, total, totalMs){
      return {
        attempt_key: uuidv4(),
        student_id: "",
        started_at: sessionStartedAt.toISOString(),
        finished_at: new Date().toISOString(),
        score: correctCount, total: total, duration_ms: Math.round(totalMs),
        seed: seed|0, bank_hash: BANK_HASH, app_version: APP_VERSION,
        mode: "infinite",
        topics_selected: selectedTopics.slice(),
        question_pool_size: filteredBank.length,
        ua: navigator.userAgent, page_url: location.href,
        answers: rows.map(r => ({
          qid:r.qid, topic:r.topic, idx:r.idx, stem:r.stem,
          options_presented:r.optionsPresented, correct:r.correctText,
          selected: r.yourText==="—" ? null : r.yourText, ok:r.ok, time_ms:Math.round(r.time)
        }))
      };
    }

    async function finish(){
      stopTimer();
      const total=questions.length; let correctCount=0; const rows=[];
      for (let i=0;i<total;i++){
        const q=questions[i], sel=answers[i], ok=(sel===q.correctRendered); if (ok) correctCount++;
        const presented=q.choiceIdxs.map(k=>q.opts[k]), correctText=q.opts[q.choiceIdxs[q.correctRendered]], yourText=(sel==null)?"—":q.opts[q.choiceIdxs[sel]];
        rows.push({ idx:i, qid:q.qid, topic:q.topic, stem:q.stem, optionsPresented:presented, yourText, correctText, ok, time:times[i] });
      }
      const totalMs=times.reduce((a,b)=>a+b,0), avgMs=totalMs/Math.max(1,total);
      document.getElementById("quiz").classList.add("hidden"); document.getElementById("report").classList.remove("hidden");
      document.getElementById("score").textContent = `${correctCount} из ${total} (${Math.round(100*correctCount/Math.max(1,total))}%)`;
      document.getElementById("totaltime").textContent = fmtTime(totalMs); document.getElementById("avgtime").textContent = fmtTime(avgMs);
      const tbody=document.getElementById("tbody"); tbody.innerHTML="";
      rows.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.idx+1}</td><td>${r.stem}</td><td>${r.yourText}</td><td>${r.ok?"<span class='ok'>верно</span>":"<span class='no'>ошибка</span>"}</td><td class="timer">${fmtTime(r.time)}</td><td>${r.correctText}</td>`;
        tbody.appendChild(tr);
      });
      const status=document.getElementById("sendstatus"); status.textContent="Сохранение результата…";

      let studentId=localStorage.getItem(STUDENT_KEY);
      if (!studentId){ const v=prompt("Введите ваш код/инициалы:"); if (v){ studentId=String(v).trim(); localStorage.setItem(STUDENT_KEY, studentId);} }
      const summary=buildSummary(rows, correctCount, total, totalMs); summary.student_id = studentId || "";
      if (!summary.student_id){ status.textContent="Код ученика не указан — статистика не отправлена."; await typeset(document.getElementById("report")); return; }
      try{ await sendToSupabase(summary); status.textContent="✅ Отправлено"; }
      catch(e){ enqueueAttempt(summary); status.textContent="⚠️ Нет сети или ошибка сервера — отправим позже."; }
      await typeset(document.getElementById("report"));
    }

    function restart(){
      if (!confirm("Перезапустить и выбрать темы заново? Текущая попытка будет сброшена.")) return;
      document.getElementById("report").classList.add("hidden");
      document.getElementById("quiz").classList.add("hidden");
      openTopicsModal(true);
    }

    function changeStudent(){
      const cur=localStorage.getItem(STUDENT_KEY)||"";
      const v=prompt("Введите код/инициалы ученика", cur);
      if (v===null) return;
      const s=String(v).trim();
      if (s) localStorage.setItem(STUDENT_KEY, s); else localStorage.removeItem(STUDENT_KEY);
    }

    function changeTopics(){
      if (!confirm("Сменить темы? Текущая попытка будет сброшена.")) return;
      openTopicsModal(false);
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      // Кнопки навигации
      document.getElementById("next").addEventListener("click", nextQ, {passive:true});
      document.getElementById("prev").addEventListener("click", prevQ, {passive:true});
      document.getElementById("finish").addEventListener("click", finish, {passive:true});
      document.getElementById("restart").addEventListener("click", restart, {passive:true});
      document.getElementById("changeStudent").addEventListener("click", changeStudent, {passive:true});
      document.getElementById("changeTopics").addEventListener("click", changeTopics, {passive:true});

      // Модал выбора тем
      document.getElementById("selectAll").addEventListener("click", selectAllToggle);
      document.getElementById("startBtn").addEventListener("click", ()=>{
        const keys = getSelectedTopicKeys();
        if (!keys.length) return;
        startSession(keys); // внутри скроется модалка
        document.getElementById("quiz").classList.remove("hidden");
      });
      document.getElementById("topicsModal").addEventListener("change", (e)=>{
        if (e.target.matches('input[type="checkbox"]')){
          validateTopicsSelection();
          updateSelectAllLabel(); // чтобы текст кнопки менялся, если пользователь вручную отметил/снял
        }
      });

      setInterval(flushQueue, 30000);
      flushQueue();

      openTopicsModal(true); // изначально ничто не выбрано
    });
  </script>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="row" style="margin-bottom:10px">
      <h1 class="grow">Тренажер по формулам стереометрии</h1>
      <button id="changeTopics" class="linklike head-mini" title="Сменить темы">Темы</button>
      <button id="changeStudent" class="linklike head-mini" title="Сменить ученика">Сменить ученика</button>
    </div>

    <!-- Quiz Card -->
    <div class="card hidden" id="quiz">
      <div class="row">
        <div id="qnum" class="grow"></div>
        <div class="timer">00:00.00</div>
      </div>

      <div class="qtext"></div>
      <div class="opts"></div>

      <div class="btns">
        <button id="prev" class="ghost">Назад</button>
        <button id="next" class="ghost">Дальше</button>
        <div class="grow"></div>
        <button id="finish" class="primary">Завершить</button>
      </div>
    </div>

    <!-- Report -->
    <div class="card hidden" id="report">
      <h1>Статистика</h1>
      <div class="row">
        <span>Результат: <span id="score"></span></span>
        <span>Итоговое время: <span id="totaltime" class="timer"></span></span>
        <span>Среднее на вопрос: <span id="avgtime" class="timer"></span></span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>№</th>
              <th>Вопрос</th>
              <th>Ваш ответ</th>
              <th>Оценка</th>
              <th>Время</th>
              <th>Правильный ответ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="status" id="sendstatus"> </div>
      <div class="btns">
        <button id="restart" class="primary">Перезапустить</button>
      </div>
      <div class="tiny">Версия: <span id="ver"></span></div>
    </div>
  </div>

  <!-- Modal: topics selection -->
  <div id="topicsModal" class="modal-backdrop hidden">
    <div class="modal">
      <h1>Выберите темы</h1>
      <div class="muted" style="margin:6px 0 8px">Можно выбрать от одной до всех тем</div>

      <div class="chkrow"><input id="t1" type="checkbox" value="цилиндр"><label for="t1">Цилиндр</label></div>
      <div class="chkrow"><input id="t2" type="checkbox" value="конус"><label for="t2">Конус</label></div>
      <div class="chkrow"><input id="t3" type="checkbox" value="призма"><label for="t3">Призма</label></div>
      <div class="chkrow"><input id="t4" type="checkbox" value="шар"><label for="t4">Шар</label></div>
      <div class="chkrow"><input id="t5" type="checkbox" value="circlebundle"><label for="t5">Круг / Окружность</label></div>

      <div id="topicsWarn" class="tiny" style="margin-top:6px;color:var(--bad)"></div>

      <div class="btns" style="margin-top:14px">
        <button id="selectAll" class="ghost" type="button">Выбрать все</button>
        <div class="grow"></div>
        <button id="startBtn" class="primary" type="button" disabled>Начать</button>
      </div>
      <div class="tiny muted" style="margin-top:8px">Изначально ничего не выбрано</div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", ()=>{
      const el=document.getElementById("ver"); if (el) el.textContent = APP_VERSION;
    });
  </script>
</body>
</html>
